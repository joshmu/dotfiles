#!/usr/bin/env bun
// tmux-fzf-sessions - fzf session picker with zoxide integration
// Enter: switch to session/create from directory
// Ctrl+K: kill selected session (safely switches away first if current)

import { $ } from "bun";

// Colors
const GREEN = "\x1b[32m";
const YELLOW = "\x1b[33m";
const BLUE = "\x1b[34m";
const MAGENTA = "\x1b[35m";
const RESET = "\x1b[0m";

const stripAnsi = (str: string) => str.replace(/\x1b\[[0-9;]*m/g, "");

const currentSession = async () => {
  try {
    const result = await $`tmux display-message -p '#S'`.quiet().text();
    return result.trim();
  } catch {
    return "";
  }
};

const run = async (cmd: string[]) => {
  try {
    const proc = Bun.spawn(cmd, { stdout: "pipe", stderr: "pipe" });
    const text = await new Response(proc.stdout).text();
    return text.trim();
  } catch {
    return "";
  }
};

// Handle --kill flag
if (process.argv[2] === "--kill" && process.argv[3]) {
  let target = stripAnsi(process.argv[3]);
  target = target.replace(/ 󰄬$/, "").replace(/ 󰚩( 󰚩)*$/, "");
  const current = await currentSession();

  if (target === current) {
    const sessions = await run(["tmux", "list-sessions", "-F", "#{session_activity}:#{session_name}"]);
    const other = sessions
      .split("\n")
      .filter((l) => !l.endsWith(`:${current}`))
      .sort((a, b) => parseInt(b.split(":")[0]) - parseInt(a.split(":")[0]))[0]
      ?.split(":")[1];
    if (other) {
      await $`tmux switch-client -t ${other}`.quiet();
      await $`tmux kill-session -t ${target}`.quiet();
    }
  } else {
    await $`tmux kill-session -t ${target}`.quiet();
  }
  process.exit(0);
}

// Build pane_pid -> session map
const paneToSession = new Map<string, string>();
const paneData = await run(["tmux", "list-panes", "-a", "-F", "#{session_name}:#{pane_pid}"]);
for (const line of paneData.split("\n")) {
  const [session, pid] = line.split(":");
  if (session && pid) paneToSession.set(pid, session);
}

// Find Claude processes and count per session
const claudeSessions = new Map<string, number>();
const claudePids = await run(["pgrep", "-x", "claude"]);

for (const cpid of claudePids.split("\n")) {
  if (!cpid || !/^\d+$/.test(cpid)) continue;

  let ppid = cpid;
  for (let i = 0; i < 5; i++) {
    ppid = await run(["ps", "-o", "ppid=", "-p", ppid]);
    ppid = ppid.trim();
    if (!ppid || ppid === "1") break;

    const session = paneToSession.get(ppid);
    if (session) {
      claudeSessions.set(session, (claudeSessions.get(session) || 0) + 1);
      break;
    }
  }
}

// Get current session
const current = await currentSession();

// Build session list
const sessionsData = await run(["tmux", "list-sessions", "-F", "#{session_activity}:#{session_name}"]);
const sessions = sessionsData
  .split("\n")
  .filter(Boolean)
  .sort((a, b) => parseInt(b.split(":")[0]) - parseInt(a.split(":")[0]))
  .map((line) => {
    const name = line.split(":")[1];
    const claudeCount = claudeSessions.get(name) || 0;
    const claudeIndicator = claudeCount > 0 ? ` ${MAGENTA}${Array(claudeCount).fill("󰚩").join(" ")}${RESET}` : "";

    if (name === current) {
      return `${YELLOW}${name}${claudeIndicator} 󰄬${RESET}`;
    }
    return `${GREEN}${name}${claudeIndicator}${RESET}`;
  });

// Build zoxide list
const zoxideDirs = await run(["zoxide", "query", "-l"]);
const directories = zoxideDirs
  .split("\n")
  .filter(Boolean)
  .slice(0, 20)
  .map((dir) => `${BLUE}${dir}${RESET}`);

// Combine and run fzf
const combined = [...sessions, ...directories].join("\n");

const fzf = Bun.spawn(
  [
    "fzf",
    "--ansi",
    "--reverse",
    "--disabled",
    "--header",
    "(╯°□°)╯︵ ┻━┻",
    "--header-first",
    "--bind",
    "j:down,k:up",
    "--bind",
    "/:enable-search",
    "--bind",
    "ctrl-o:accept",
    "--preview-window=right:60%",
    "--preview",
    `item=$(echo {} | sed "s/\\x1b\\[[0-9;]*m//g"); if [[ "$item" != /* ]]; then name=$(echo "$item" | sed "s/ 󰚩.*$//" | sed "s/ 󰄬//"); printf "\\e[38;5;245m"; tmux capture-pane -pt "$name" -p 2>/dev/null | tail -40; printf "\\e[0m" || echo "No preview"; else printf "\\e[38;5;245m"; ls -la "$item" 2>/dev/null; printf "\\e[0m" || echo "Directory"; fi`,
    "--expect=ctrl-k,ctrl-o,enter",
  ],
  {
    stdin: "pipe",
    stdout: "pipe",
    stderr: "inherit",
  }
);

fzf.stdin.write(combined);
fzf.stdin.end();

const result = await new Response(fzf.stdout).text();
const lines = result.trim().split("\n");
const key = lines[0];
const selected = stripAnsi(lines.slice(1).join("\n"));

if (!selected) process.exit(0);

// Ctrl+K: kill session
if (key === "ctrl-k" && !selected.startsWith("/")) {
  await $`${process.argv[1]} --kill ${selected}`.quiet();
  process.exit(0);
}

// Enter: switch or create
if (!selected.startsWith("/")) {
  let sessionName = selected.replace(/ 󰄬$/, "").replace(/ 󰚩( 󰚩)*$/, "");
  await $`tmux switch-client -t ${sessionName}`.quiet();
  process.exit(0);
}

// Directory selected - create/switch to session
const selectedName = selected.split("/").pop()?.replace(/\./g, "_") || "session";
const inTmux = process.env.TMUX;
const tmuxRunning = await run(["pgrep", "tmux"]);

if (!inTmux && !tmuxRunning) {
  await $`tmux new-session -s ${selectedName} -c ${selected}`.quiet();
  process.exit(0);
}

const hasSession = await run(["tmux", "has-session", "-t", selectedName]);
if (!hasSession) {
  await $`tmux new-session -ds ${selectedName} -c ${selected}`.quiet();
}

await $`tmux switch-client -t ${selectedName}`.quiet();

#!/usr/bin/env bash
# tmux-fzf-sessions - fzf session picker with zoxide integration
# Enter: switch to session/create from directory
# Ctrl+K: kill selected session (safely switches away first if current)

# Colors
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
MAGENTA='\033[35m'
RESET='\033[0m'

current_session() {
    tmux display-message -p '#S' 2>/dev/null
}

# Strip ANSI codes for processing
strip_ansi() {
    sed 's/\x1b\[[0-9;]*m//g'
}

# Handle --kill flag (called internally)
if [[ "$1" == "--kill" && -n "$2" ]]; then
    target=$(echo "$2" | strip_ansi)  # Remove colors
    target="${target% 󰄬}"  # Remove attached indicator
    target="${target% 󰚩}"  # Remove claude indicator
    target="${target% 󰚩 󰄬}"  # Remove both indicators
    current=$(current_session)

    if [[ "$target" == "$current" ]]; then
        # Get most recently active session (excluding current), sorted by activity descending
        other=$(tmux list-sessions -F '#{session_activity}:#{session_name}' | \
            grep -v ":${current}$" | sort -rn | head -1 | cut -d: -f2)
        if [[ -n "$other" ]]; then
            tmux switch-client -t "$other"
            tmux kill-session -t "$target"
        fi
    else
        tmux kill-session -t "$target"
    fi
    exit 0
fi

# Check if session has claude running in any pane
has_claude() {
    local session="$1"
    tmux list-panes -t "$session" -F '#{pane_pid}' 2>/dev/null | while read -r pid; do
        if pgrep -P "$pid" -f "claude" >/dev/null 2>&1; then
            echo "yes"
            return
        fi
    done
}

# Get current session for highlighting
current=$(current_session)

# Collect sessions (sorted by activity, colored)
sessions=$(tmux list-sessions -F "#{session_activity}:#{session_name}" 2>/dev/null | sort -rn | while IFS=: read -r activity name; do
    claude_indicator=""
    [[ -n "$(has_claude "$name")" ]] && claude_indicator=" ${MAGENTA}󰚩${RESET}"

    if [[ "$name" == "$current" ]]; then
        echo -e "${YELLOW}${name}${claude_indicator} 󰄬${RESET}"
    else
        echo -e "${GREEN}${name}${claude_indicator}${RESET}"
    fi
done)

# Collect zoxide directories (frecency sorted, colored)
zoxide_dirs=$(zoxide query -l 2>/dev/null | head -20 | while read -r dir; do
    echo -e "${BLUE}${dir}${RESET}"
done)

# Combine: sessions first, then zoxide dirs
combined=$(printf "%s\n%s" "$sessions" "$zoxide_dirs" | grep -v '^$')

# fzf with expect for ctrl-k
result=$(echo -e "$combined" | fzf --ansi --reverse --disabled \
    --header "(╯°□°)╯︵ ┻━┻" --header-first \
    --bind 'j:down,k:up' \
    --bind '/:enable-search' \
    --bind 'ctrl-o:accept' \
    --preview-window=right:60% \
    --preview 'item=$(echo {} | sed "s/\x1b\[[0-9;]*m//g"); if [[ "$item" != /* ]]; then name=$(echo "$item" | sed "s/ 󰚩//" | sed "s/ 󰄬//"); printf "\e[38;5;245m"; tmux capture-pane -pt "$name" -p 2>/dev/null | tail -40; printf "\e[0m" || echo "No preview"; else printf "\e[38;5;245m"; ls -la "$item" 2>/dev/null; printf "\e[0m" || echo "Directory"; fi' \
    --expect=ctrl-k)

key=$(echo "$result" | head -1)
selected=$(echo "$result" | tail -n +2 | strip_ansi)

[[ -z "$selected" ]] && exit 0

# Ctrl+K: kill session (only for sessions, not directories)
if [[ "$key" == "ctrl-k" ]]; then
    if [[ "$selected" != /* ]]; then  # Not a directory path
        "$0" --kill "$selected"
    fi
    exit 0
fi

# Enter: switch or create
if [[ "$selected" != /* ]]; then  # Session (not a directory path)
    session_name="$selected"
    session_name="${session_name% 󰄬}"  # Remove attached indicator
    session_name="${session_name% 󰚩}"  # Remove claude indicator
    session_name="${session_name% 󰚩 󰄬}"  # Remove both indicators
    tmux switch-client -t "$session_name"
    exit 0
fi

# Directory selected - create/switch to session
selected_name=$(basename "$selected" | tr . _)

if [[ -z "$TMUX" ]] && [[ -z "$(pgrep tmux)" ]]; then
    tmux new-session -s "$selected_name" -c "$selected"
    exit 0
fi

if ! tmux has-session -t="$selected_name" 2>/dev/null; then
    tmux new-session -ds "$selected_name" -c "$selected"
fi

tmux switch-client -t "$selected_name"
